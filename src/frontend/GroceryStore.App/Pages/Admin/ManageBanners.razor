@page "/admin/banners"
@using GroceryStore.App.Models
@using GroceryStore.App.Services.Interfaces
@layout GroceryStore.App.Components.Layout.AdminLayout
@inject IBannerService BannerService

<PageTitle>Manage Banners | Admin</PageTitle>

<div style="display:flex;justify-content:space-between;align-items:center;margin-bottom:2rem;flex-wrap:wrap;gap:1rem;">
    <h2 style="font-size:1.5rem;font-weight:700;">
        <i class="fas fa-images" style="color:var(--primary);margin-right:.5rem;"></i>
        Banners
    </h2>
    <button class="btn btn-primary" @onclick="OpenNew"><i class="fas fa-plus"></i> Add Banner</button>
</div>

<Toast @ref="_toast" />

@if (_loading)
{
    <div class="loading-spinner show"><div class="spinner"></div></div>
}
else
{
    <div class="table-wrapper" style="background:var(--surface);border-radius:var(--radius-lg);border:1px solid var(--border);overflow:auto;">
        <table style="width:100%;border-collapse:collapse;">
            <thead>
                <tr style="background:var(--bg);border-bottom:2px solid var(--border);">
                    <th style="padding:14px 16px;text-align:left;">Preview</th>
                    <th style="padding:14px 16px;text-align:left;">Title</th>
                    <th style="padding:14px 16px;text-align:left;">Placement</th>
                    <th style="padding:14px 16px;text-align:center;">Images</th>
                    <th style="padding:14px 16px;text-align:center;">Order</th>
                    <th style="padding:14px 16px;text-align:center;">Active</th>
                    <th style="padding:14px 16px;text-align:center;">Actions</th>
                </tr>
            </thead>
            <tbody>
                @if (_banners.Count == 0)
                {
                    <tr><td colspan="7" style="padding:3rem;text-align:center;color:var(--text-light);">No banners yet.</td></tr>
                }
                @foreach (var b in _banners)
                {
                    <tr style="border-bottom:1px solid var(--border);">
                        <td style="padding:12px 16px;">
                            <img src="@(b.ImageUrl ?? b.Images.FirstOrDefault( ) ?? "images/ui/banner-placeholder.svg")"
                                 style="width:90px;height:50px;object-fit:cover;border-radius:var(--radius-sm);" />
                        </td>
                        <td style="padding:12px 16px;font-weight:500;">@b.Title</td>
                        <td style="padding:12px 16px;color:var(--text-light);">@b.Placement</td>
                        <td style="padding:12px 16px;text-align:center;">@b.Images.Count</td>
                        <td style="padding:12px 16px;text-align:center;">@b.DisplayOrder</td>
                        <td style="padding:12px 16px;text-align:center;">
                            <span style="color:@(b.IsActive ? "#059669" : "#dc2626");">
                                <i class="fas @(b.IsActive ? "fa-check-circle" : "fa-times-circle")"></i>
                            </span>
                        </td>
                        <td style="padding:12px 16px;text-align:center;white-space:nowrap;">
                            <button class="btn-edit" @onclick="() => OpenEdit(b)"><i class="fas fa-edit"></i></button>
                            <button class="btn-delete" @onclick="() => ConfirmDelete(b)"><i class="fas fa-trash"></i></button>
                        </td>
                    </tr>
                }
            </tbody>
        </table>
    </div>
}

<!-- Modal -->
<div class="modal @(_showModal ? "show" : "")">
    <div class="modal-content" style="max-width:520px;">
        <div class="modal-header">
            <h3>@(_form.Id == 0 ? "Add Banner" : "Edit Banner")</h3>
            <button class="modal-close" @onclick="CloseModal"><i class="fas fa-times"></i></button>
        </div>
        <div class="modal-body">
            <EditForm Model="_form" OnValidSubmit="Save">
                <DataAnnotationsValidator />
                <div class="form-group">
                    <label class="form-label">Title *</label>
                    <InputText @bind-Value="_form.Title" class="form-control" placeholder="e.g. This Week's Deals" />
                </div>
                <div class="form-group">
                    <label class="form-label">Placement</label>
                    <InputSelect @bind-Value="_form.Placement" class="form-control">
                        <option value="HomeHero">Home Hero</option>
                        <option value="Sidebar">Sidebar</option>
                        <option value="Footer">Footer</option>
                    </InputSelect>
                </div>
                <div class="form-group">
                    <label class="form-label">Link URL (e.g. products, categories/fruits)</label>
                    <InputText @bind-Value="_form.LinkUrl" class="form-control" placeholder="products" />
                </div>
                <div class="form-group">
                    <label class="form-label">Image URLs (one per line)</label>
                    <textarea class="form-control" rows="4" @bind="_imagesText" placeholder="https://example.com/banner1.jpg"></textarea>
                </div>
                <div class="form-group">
                    <label class="form-label">Display Order</label>
                    <InputNumber @bind-Value="_form.DisplayOrder" class="form-control" />
                </div>
                <div class="form-group" style="display:flex;align-items:center;gap:.5rem;">
                    <InputCheckbox @bind-Value="_form.IsActive" id="bannerActive" />
                    <label for="bannerActive">Active</label>
                </div>
                <div style="display:flex;gap:1rem;justify-content:flex-end;margin-top:1rem;">
                    <button type="button" class="btn-secondary" @onclick="CloseModal">Cancel</button>
                    <button type="submit" class="btn-submit" disabled="@_busy">
                        @if (_busy)
                        {
                            <i class="fas fa-spinner fa-spin"></i>
                        }
                        else
                        {

                            <i class="fas fa-save"></i>
                        }
                        Save
                    </button>
                </div>
            </EditForm>
        </div>
    </div>
</div>

<ConfirmDialog @ref="_dlg" OnConfirmed="DeleteConfirmed" />

@code {
    private Toast? _toast;
    private ConfirmDialog? _dlg;
    private bool _loading, _showModal, _busy;
    private string _imagesText = string.Empty;
    private List<Banner> _banners = new( );
    private Banner _form = new( );
    private Banner? _toDelete;

    protected override async Task OnInitializedAsync()
    {
        _loading = true;
        _banners = await BannerService.GetAllBannersAsync( );
        _loading = false;
    }

    private void OpenNew()
    {
        _form = new Banner { IsActive = true,Placement = "HomeHero" };
        _imagesText = string.Empty;
        _showModal = true;
    }

    private void OpenEdit(Banner b)
    {
        _form = new Banner
        {
            Id = b.Id,
            Title = b.Title,
            Placement = b.Placement,
            LinkUrl = b.LinkUrl,
            DisplayOrder = b.DisplayOrder,
            IsActive = b.IsActive,
            Images = new(b.Images),
            ImageUrl = b.ImageUrl
        };
        _imagesText = string.Join("\n",b.Images);
        _showModal = true;
    }

    private void CloseModal() => _showModal = false;

    private async Task Save()
    {
        _busy = true;
        _form.Images = _imagesText.Split('\n',StringSplitOptions.RemoveEmptyEntries | StringSplitOptions.TrimEntries).ToList( );
        _form.ImageUrl = _form.Images.FirstOrDefault( );
        if (_form.Id == 0)
            await BannerService.CreateBannerAsync(_form);
        else
            await BannerService.UpdateBannerAsync(_form);
        _busy = false;
        _showModal = false;
        _toast?.Show(_form.Id == 0 ? "Banner added!" : "Banner updated!");
        _banners = await BannerService.GetAllBannersAsync( );
    }

    private void ConfirmDelete(Banner b) { _toDelete = b; _dlg?.ShowAsync( ); }
    private async Task DeleteConfirmed()
    {
        if (_toDelete is null)
            return;
        await BannerService.DeleteBannerAsync(_toDelete.Id);
        _toast?.Show("Banner deleted.",Toast.ToastType.Warning);
        _banners.Remove(_toDelete);
        _toDelete = null;
    }
}
