@page "/admin/login"
@using GroceryStore.App.Models
@using GroceryStore.App.Services.Interfaces
@layout GroceryStore.App.Components.Layout.MainLayout
@inject IAuthService    AuthService
@inject NavigationManager Nav

<PageTitle>Admin Login | Fresh Grocery</PageTitle>

<div style="min-height:70vh;display:flex;align-items:center;justify-content:center;padding:2rem;">
    <div style="width:100%;max-width:420px;background:var(--surface);border-radius:var(--radius-xl);
                border:1px solid var(--border);padding:3rem 2.5rem;box-shadow:var(--shadow-lg);">

        <div style="text-align:center;margin-bottom:2.5rem;">
            <i class="fas fa-shopping-basket" style="font-size:3rem;color:var(--primary);"></i>
            <h1 style="font-size:1.8rem;font-weight:700;margin:.75rem 0 .25rem;">Admin Login</h1>
            <p style="color:var(--text-light);">Sign in to manage your store</p>
        </div>

        @if (!string.IsNullOrWhiteSpace(_errorMsg))
        {
            <div style="background:#fee2e2;border:1px solid #fca5a5;color:#991b1b;padding:1rem;border-radius:var(--radius-md);margin-bottom:1.5rem;font-size:.9rem;">
                <i class="fas fa-exclamation-circle"></i> @_errorMsg
            </div>
        }

        <EditForm Model="_creds" OnValidSubmit="HandleLogin">
            <DataAnnotationsValidator />

            <div class="form-group">
                <label class="form-label">Username</label>
                <div style="position:relative;">
                    <i class="fas fa-user" style="position:absolute;left:14px;top:50%;transform:translateY(-50%);color:var(--text-light);"></i>
                    <InputText @bind-Value="_creds.Username" class="form-control"
                               style="padding-left:42px;"
                               placeholder="Enter username"
                               autocomplete="username" />
                </div>
                <ValidationMessage For="() => _creds.Username" />
            </div>

            <div class="form-group">
                <label class="form-label">Password</label>
                <div style="position:relative;">
                    <i class="fas fa-lock" style="position:absolute;left:14px;top:50%;transform:translateY(-50%);color:var(--text-light);"></i>
                    <InputText @bind-Value="_creds.Password" type="password" class="form-control"
                               style="padding-left:42px;"
                               placeholder="Enter password"
                               autocomplete="current-password" />
                </div>
                <ValidationMessage For="() => _creds.Password" />
            </div>

            <button type="submit" class="btn btn-primary" style="width:100%;padding:1rem;font-size:1.05rem;margin-top:.5rem;" disabled="@_busy">
                @if (_busy)
                {
                    <i class="fas fa-spinner fa-spin"></i> <span>Signing inâ€¦</span>
                }
                else
                {
                    <i class="fas fa-sign-in-alt"></i> <span>Sign In</span>
                }
            </button>
        </EditForm>

        <div style="margin-top:2rem;padding:1rem;background:var(--bg);border-radius:var(--radius-md);border:1px solid var(--border);font-size:.85rem;color:var(--text-light);">
            <strong>Test credentials:</strong><br/>
            Username: <code>admin</code> &nbsp;|&nbsp; Password: <code>admin123</code>
        </div>
    </div>
</div>

@code {
    private readonly AdminCredentials _creds    = new();
    private string   _errorMsg = string.Empty;
    private bool     _busy;

    protected override void OnInitialized()
    {
        if (AuthService.IsAuthenticated)
            Nav.NavigateTo("/admin/dashboard");
    }

    private async Task HandleLogin()
    {
        _busy = true; _errorMsg = string.Empty;
        var token = await AuthService.LoginAsync(_creds.Username, _creds.Password);
        _busy = false;
        if (token is null)
            _errorMsg = "Invalid username or password. Please try again.";
        else
            Nav.NavigateTo("/admin/dashboard");
    }
}
