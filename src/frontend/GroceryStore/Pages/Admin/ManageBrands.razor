@page "/admin/brands"
@layout GroceryStore.Components.Layout.AdminLayout
@inject IBrandService BrandService

<PageTitle>Manage Brands | Admin</PageTitle>

<div style="display:flex;justify-content:space-between;align-items:center;margin-bottom:2rem;flex-wrap:wrap;gap:1rem;">
    <h2 style="font-size:1.5rem;font-weight:700;">
        <i class="fas fa-tag" style="color:var(--primary);margin-right:.5rem;"></i>
        Brands
    </h2>
    <button class="btn btn-primary" @onclick="OpenNew"><i class="fas fa-plus"></i> Add Brand</button>
</div>

<Toast @ref="_toast" />

@if (_loading)
{
    <div class="loading-spinner show"><div class="spinner"></div></div>
}
else
{
    <div class="table-wrapper" style="background:var(--surface);border-radius:var(--radius-lg);border:1px solid var(--border);overflow:auto;">
        <table style="width:100%;border-collapse:collapse;">
            <thead>
                <tr style="background:var(--bg);border-bottom:2px solid var(--border);">
                    <th style="padding:14px 16px;text-align:left;">Name</th>
                    <th style="padding:14px 16px;text-align:left;">Slug</th>
                    <th style="padding:14px 16px;text-align:center;">Active</th>
                    <th style="padding:14px 16px;text-align:center;">Actions</th>
                </tr>
            </thead>
            <tbody>
                @if (_brands.Count == 0)
                {
                    <tr><td colspan="4" style="padding:3rem;text-align:center;color:var(--text-light);">No brands yet.</td></tr>
                }
                @foreach (var b in _brands)
                {
                    <tr style="border-bottom:1px solid var(--border);">
                        <td style="padding:12px 16px;font-weight:500;">@b.Name</td>
                        <td style="padding:12px 16px;color:var(--text-light);font-size:.85rem;">@b.Slug</td>
                        <td style="padding:12px 16px;text-align:center;">
                            <span style="color:@(b.IsActive ? "#059669" : "#dc2626");">
                                <i class="fas @(b.IsActive ? "fa-check-circle" : "fa-times-circle")"></i>
                            </span>
                        </td>
                        <td style="padding:12px 16px;text-align:center;white-space:nowrap;">
                            <button class="btn-edit" @onclick="() => OpenEdit(b)"><i class="fas fa-edit"></i></button>
                            <button class="btn-delete" @onclick="() => ConfirmDelete(b)"><i class="fas fa-trash"></i></button>
                        </td>
                    </tr>
                }
            </tbody>
        </table>
    </div>
}

<!-- Modal -->
<div class="modal @(_showModal ? "show" : "")">
    <div class="modal-content" style="max-width:400px;">
        <div class="modal-header">
            <h3>@(_form.Id == 0 ? "Add Brand" : "Edit Brand")</h3>
            <button class="modal-close" @onclick="CloseModal"><i class="fas fa-times"></i></button>
        </div>
        <div class="modal-body">
            <EditForm Model="_form" OnValidSubmit="Save">
                <DataAnnotationsValidator />
                <div class="form-group">
                    <label class="form-label">Name *</label>
                    <InputText @bind-Value="_form.Name" class="form-control" placeholder="e.g. Fresh Valley" />
                </div>
                <div class="form-group">
                    <label class="form-label">Slug</label>
                    <InputText @bind-Value="_form.Slug" class="form-control" placeholder="auto-from-name" />
                </div>
                <div class="form-group" style="display:flex;align-items:center;gap:.5rem;">
                    <InputCheckbox @bind-Value="_form.IsActive" id="brandActive" />
                    <label for="brandActive">Active</label>
                </div>
                <div style="display:flex;gap:1rem;justify-content:flex-end;margin-top:1rem;">
                    <button type="button" class="btn-secondary" @onclick="CloseModal">Cancel</button>
                    <button type="submit" class="btn-submit" disabled="@_busy">
                        @if (_busy)
                        {
                            <i class="fas fa-spinner fa-spin"></i>
                        }
                        else
                        {

                            <i class="fas fa-save"></i>
                        }
                        Save
                    </button>
                </div>
            </EditForm>
        </div>
    </div>
</div>

<ConfirmDialog @ref="_dlg" OnConfirmed="DeleteConfirmed" />

@code {
    private Toast? _toast;
    private ConfirmDialog? _dlg;
    private bool _loading, _showModal, _busy;
    private List<Brand> _brands = new( );
    private Brand _form = new( );
    private Brand? _toDelete;

    protected override async Task OnInitializedAsync()
    {
        _loading = true;
        _brands = await BrandService.GetAllBrandsAsync( );
        _loading = false;
    }

    private void OpenNew() { _form = new Brand { IsActive = true }; _showModal = true; }
    private void OpenEdit(Brand b)
    {
        _form = new Brand { Id = b.Id,Name = b.Name,Slug = b.Slug,IsActive = b.IsActive };
        _showModal = true;
    }
    private void CloseModal() => _showModal = false;

    private async Task Save()
    {
        _busy = true;
        if (string.IsNullOrWhiteSpace(_form.Slug))
            _form.Slug = _form.Name.ToLower( ).Replace(" ","-").Trim( );
        if (_form.Id == 0)
            await BrandService.CreateBrandAsync(_form);
        else
            await BrandService.UpdateBrandAsync(_form);
        _busy = false;
        _showModal = false;
        _toast?.Show(_form.Id == 0 ? "Brand added!" : "Brand updated!");
        _brands = await BrandService.GetAllBrandsAsync( );
    }

    private void ConfirmDelete(Brand b) { _toDelete = b; _dlg?.ShowAsync( ); }
    private async Task DeleteConfirmed()
    {
        if (_toDelete is null)
            return;
        await BrandService.DeleteBrandAsync(_toDelete.Id);
        _toast?.Show("Brand deleted.",Toast.ToastType.Warning);
        _brands.Remove(_toDelete);
        _toDelete = null;
    }
}
